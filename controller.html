<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Tilt Party Controller</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      font-family: system-ui, sans-serif;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Views */
    .view {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 400px;
    }
    .view.active {
      display: flex;
    }

    /* Join view */
    .app-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .app-subtitle {
      font-size: 1rem;
      opacity: 0.6;
      margin-bottom: 2rem;
    }

    #status {
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      min-height: 1.5rem;
    }

    .btn {
      padding: 1rem 2.5rem;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #1a1a2e;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      box-shadow: none;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .connected { color: #4ade80; }
    .error { color: #f87171; }

    /* Game selection view */
    .section-title {
      font-size: 1.2rem;
      opacity: 0.6;
      margin-bottom: 1rem;
    }

    .game-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    .game-btn {
      width: 100%;
      padding: 1.2rem;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 16px;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
    }

    .game-btn:active {
      background: rgba(255, 215, 0, 0.2);
      border-color: #ffd700;
    }

    .game-btn .icon {
      font-size: 2rem;
      width: 50px;
      height: 50px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .game-btn .info {
      text-align: left;
    }

    .game-btn .name {
      font-weight: bold;
      margin-bottom: 0.2rem;
    }

    .game-btn .desc {
      font-size: 0.85rem;
      opacity: 0.6;
    }

    /* Controller view */
    #controller-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 40px 20px;
    }

    .game-header {
      margin-bottom: 1rem;
    }

    .game-name {
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tilt-indicator {
      width: 200px;
      height: 200px;
      border: 3px solid rgba(255, 215, 0, 0.3);
      border-radius: 50%;
      position: relative;
      margin-bottom: 1.5rem;
    }

    .tilt-dot {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      transition: transform 0.05s ease-out;
    }

    .tilt-crosshair {
      position: absolute;
      background: rgba(255, 215, 0, 0.2);
    }

    .tilt-crosshair.horizontal {
      width: 100%;
      height: 1px;
      top: 50%;
      left: 0;
    }

    .tilt-crosshair.vertical {
      width: 1px;
      height: 100%;
      top: 0;
      left: 50%;
    }

    .instruction {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .instruction-sub {
      font-size: 0.95rem;
      opacity: 0.6;
      margin-bottom: 2rem;
    }

    .end-game-btn {
      padding: 0.8rem 1.5rem;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 30px;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
    }

    .end-game-btn:active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* Action button (jump/serve) */
    .action-btn {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      border: none;
      color: #1a1a2e;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 30px rgba(255, 215, 0, 0.5);
      margin-bottom: 1.5rem;
      display: none;
      -webkit-tap-highlight-color: transparent;
    }

    .action-btn.visible {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn:active {
      transform: scale(0.92);
      box-shadow: 0 2px 15px rgba(255, 215, 0, 0.4);
    }

    /* Horizontal tilt bar for volleyball */
    .tilt-bar-container {
      width: 280px;
      height: 60px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      position: relative;
      margin-bottom: 1.5rem;
      display: none;
    }

    .tilt-bar-container.visible {
      display: block;
    }

    .tilt-bar-dot {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      border-radius: 50%;
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      transition: left 0.05s ease-out;
    }

    .tilt-bar-labels {
      position: absolute;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      padding: 0 15px;
      font-size: 0.8rem;
      opacity: 0.4;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Join view -->
  <div id="join-view" class="view active">
    <div class="app-title">Tilt Party</div>
    <div class="app-subtitle">Phone Controller</div>
    <p id="status">Tap to connect</p>
    <button id="connect-btn" class="btn">Connect</button>
  </div>

  <!-- Game selection view -->
  <div id="select-view" class="view">
    <div class="app-title">Tilt Party</div>
    <p class="section-title">Select a game to play</p>
    <div class="game-list" id="game-list">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- Controller view (in-game) -->
  <div id="controller-view" class="view">
    <div class="game-header">
      <div class="game-name" id="current-game-name">Bumper Cars</div>
    </div>
    <button id="action-btn" class="action-btn">JUMP</button>
    <div class="tilt-indicator" id="tilt-indicator">
      <div class="tilt-crosshair horizontal"></div>
      <div class="tilt-crosshair vertical"></div>
      <div class="tilt-dot" id="tilt-dot"></div>
    </div>
    <div class="tilt-bar-container" id="tilt-bar">
      <div class="tilt-bar-dot" id="tilt-bar-dot"></div>
      <div class="tilt-bar-labels">
        <span>LEFT</span>
        <span>RIGHT</span>
      </div>
    </div>
    <p class="instruction" id="instruction-main">Tilt to drive!</p>
    <p class="instruction-sub" id="instruction-sub">Push others off the arena</p>
    <button id="end-game-btn" class="end-game-btn">End Game</button>
  </div>

  <script>
    let peer;
    let conn;
    let isConnected = false;
    let currentGameId = null;
    let games = [];

    // Support both ?room=XXX and #XXX formats
    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get('room') || window.location.hash.slice(1);

    if (!roomCode) {
      document.getElementById('status').textContent = 'Invalid link';
      document.getElementById('status').className = 'error';
      document.getElementById('connect-btn').disabled = true;
    }

    // View management
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
    }

    // Connect button
    document.getElementById('connect-btn').addEventListener('click', async () => {
      if (isConnected) return;

      document.getElementById('status').textContent = 'Connecting...';
      document.getElementById('connect-btn').disabled = true;

      // Request motion permission (required on iOS)
      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceMotionEvent.requestPermission();
          if (permission !== 'granted') {
            document.getElementById('status').textContent = 'Motion permission denied';
            document.getElementById('status').className = 'error';
            document.getElementById('connect-btn').disabled = false;
            return;
          }
        } catch (e) {
          console.error('Permission error:', e);
        }
      }

      // Create peer connection
      peer = new Peer();

      peer.on('open', (id) => {
        conn = peer.connect('tilt-' + roomCode);

        conn.on('open', () => {
          isConnected = true;
          startTiltTracking();
        });

        conn.on('data', (data) => {
          handleMessage(data);
        });

        conn.on('close', () => {
          isConnected = false;
          showView('join-view');
          document.getElementById('status').textContent = 'Disconnected';
          document.getElementById('status').className = 'error';
          document.getElementById('connect-btn').disabled = false;
          document.getElementById('connect-btn').textContent = 'Reconnect';
        });

        conn.on('error', (err) => {
          document.getElementById('status').textContent = 'Connection error';
          document.getElementById('status').className = 'error';
          document.getElementById('connect-btn').disabled = false;
          console.error(err);
        });
      });

      peer.on('error', (err) => {
        document.getElementById('status').textContent = 'Error: ' + err.type;
        document.getElementById('status').className = 'error';
        document.getElementById('connect-btn').disabled = false;
        console.error(err);
      });
    });

    // Handle messages from display
    function handleMessage(data) {
      if (data.type === 'game-state') {
        games = data.games || [];
        currentGameId = data.gameId;

        if (currentGameId) {
          // Game in progress, show controller
          const game = games.find(g => g.id === currentGameId);
          if (game) {
            document.getElementById('current-game-name').textContent = game.name;
          }
          showView('controller-view');
        } else {
          // In lobby, show game selection
          populateGameList();
          showView('select-view');
        }
      }
      else if (data.type === 'game-started') {
        currentGameId = data.gameId;
        const game = games.find(g => g.id === currentGameId);
        if (game) {
          document.getElementById('current-game-name').textContent = game.name;
          updateControllerUI(game);
        }
        showView('controller-view');
      }
      else if (data.type === 'game-ended') {
        currentGameId = null;
        games = data.games || games;
        populateGameList();
        showView('select-view');
      }
    }

    // Populate game selection list
    function populateGameList() {
      const listEl = document.getElementById('game-list');
      listEl.innerHTML = '';

      games.forEach(game => {
        const btn = document.createElement('button');
        btn.className = 'game-btn';
        btn.innerHTML = `
          <div class="icon">${game.icon}</div>
          <div class="info">
            <div class="name">${game.name}</div>
            <div class="desc">${game.description}</div>
          </div>
        `;
        btn.addEventListener('click', () => selectGame(game.id));
        listEl.appendChild(btn);
      });
    }

    // Select a game
    function selectGame(gameId) {
      if (conn && conn.open) {
        conn.send({ type: 'select-game', gameId });
      }
    }

    // End game button
    document.getElementById('end-game-btn').addEventListener('click', () => {
      if (conn && conn.open) {
        conn.send({ type: 'end-game' });
      }
    });

    // Action button (jump for volleyball, could be other actions for other games)
    document.getElementById('action-btn').addEventListener('click', () => {
      if (conn && conn.open) {
        // Send both serve (for initial serve) and jump (for gameplay)
        conn.send({ type: 'serve' });
      }
    });

    // Update controller UI based on game
    function updateControllerUI(game) {
      const actionBtn = document.getElementById('action-btn');
      const tiltIndicator = document.getElementById('tilt-indicator');
      const tiltBar = document.getElementById('tilt-bar');
      const instructionMain = document.getElementById('instruction-main');
      const instructionSub = document.getElementById('instruction-sub');

      if (game.id === 'beach-volleyball') {
        actionBtn.classList.add('visible');
        actionBtn.textContent = 'JUMP';
        tiltIndicator.style.display = 'none';
        tiltBar.classList.add('visible');
        instructionMain.textContent = 'Tilt left/right to move';
        instructionSub.textContent = 'Jump to hit the ball!';
      } else if (game.id === 'bumper-cars') {
        actionBtn.classList.remove('visible');
        tiltIndicator.style.display = 'block';
        tiltBar.classList.remove('visible');
        instructionMain.textContent = 'Tilt to drive!';
        instructionSub.textContent = 'Push others off the arena';
      } else {
        actionBtn.classList.remove('visible');
        tiltIndicator.style.display = 'block';
        tiltBar.classList.remove('visible');
        instructionMain.textContent = 'Tilt to move!';
        instructionSub.textContent = '';
      }
    }

    // Tilt tracking
    function startTiltTracking() {
      let lastSend = 0;
      const throttleMs = 50;
      const tiltDot = document.getElementById('tilt-dot');
      const tiltBarDot = document.getElementById('tilt-bar-dot');

      window.addEventListener('deviceorientation', (e) => {
        const now = Date.now();
        if (now - lastSend < throttleMs) return;
        lastSend = now;

        const beta = e.beta || 0;
        const gamma = e.gamma || 0;

        const normalizedBeta = Math.max(-30, Math.min(30, beta - 30)) / 30;
        const normalizedGamma = Math.max(-30, Math.min(30, gamma)) / 30;

        // Update circular indicator (for bumper cars)
        const offsetX = normalizedGamma * 70;
        const offsetY = normalizedBeta * 70;
        tiltDot.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;

        // Update horizontal bar indicator (for volleyball)
        const barOffset = normalizedGamma * 115; // 280px width - 50px dot = 230px range, so Â±115px
        tiltBarDot.style.left = `calc(50% + ${barOffset}px)`;

        if (conn && conn.open) {
          conn.send({
            type: 'tilt',
            beta: normalizedBeta,
            gamma: normalizedGamma
          });
        }
      });
    }

    // Prevent scrolling/zooming
    document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
  </script>
</body>
</html>
